<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=11"/>
<meta name="generator" content="DoxyPress 1.7.0"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Vireo: Images</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<link href="doxypress.css" rel="stylesheet" type="text/css" />
<link href="doxygen-awesome.css" rel="stylesheet" type="text/css"/>
<link href="custom.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by DoxyPress -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectlogo"><img alt="Logo" src="logo.png"/></td>
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">Vireo
      &#160;<span id="projectnumber">0.0</span>
   </div>
   <div id="projectbrief">Vireo 3D Rendering Hardware Interface</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by DoxyPress 1.7.0 -->
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li class="current"><a href="pages.html"><span>Documentation</span></a></li>
      <li><a href="annotated.html"><span>Classes</span></a></li>
    </ul>
  </div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
$(document).ready(function(){initNavTree('manual_030_02_resources.html',''); initResizable(); });
</script>
<div id="doc-content">
<div class="header">
  <div class="headertitle">
    <div class="title">Images </div>
  </div>
  <div class="clear-floats"></div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p>The <a class="el" href="classvireo_1_1Image.html">Image</a> class represent multidimensional arrays of data which can be used for various purposes (e.g. attachments, textures), by binding them to a graphics or compute pipeline via <a class="el" href="manual_040_00_descriptors.html">descriptor sets</a>, or by directly specifying them as parameters to certain commands.</p>
<p>An image have a <a class="el" href="namespacevireo.html#a22f6b18e781e3c412e7d243f7de6aa5c">pixel format</a>. Vireo supports images formats that are commons to both Vulkan and DirectX, so it's safe to use any of theses formats without compromising portability.</p>
<p>They are created with <a class="el" href="classvireo_1_1Vireo.html#a15fb317160440594ccf02dd086023129">vireo::Vireo::createImage</a>. You need to provide the format, the width and height in number of pixels, the number of mips level (e.g. for mipmaps) and the size of the image array (e.g. 6 for a cubemap) :</p>
<div class="fragment"><div class="line">texture = <a class="code" href="namespacevireo.html">vireo</a>-&gt;createImage(<a class="code" href="namespacevireo.html#a22f6b18e781e3c412e7d243f7de6aa5ca5c835c7ea238d0796853827ce416a5e2">vireo::ImageFormat::R8G8B8A8_SRGB</a>, 512, 512, 1, 1, L<span class="stringliteral">&quot;CheckerBoardTexture&quot;</span>);</div>
</div><!-- end fragment -->
<p>The last parameter is the resource name used when you debug the rendering process with tools like <a href="https://renderdoc.org/">RenderDoc</a>.</p>
<h2>Uploading an image</h2>
<p>To be accessible by the GPU and the shader an image needs to be uploaded into video memory (VRAM).</p>
<p>Like for memory buffers there is two methods to upload an image into the GPU memory :</p><ul>
<li>Using <code>upload()</code> : the easy way</li>
<li>Using <code>copy()</code>: the flexible way</li>
</ul>
<h3>using upload()</h3>
<p>By using the <a class="el" href="classvireo_1_1CommandList.html#a44291fef9821033f491516f6bf0d4ba4">vireo::CommandList::upload</a> or <a class="el" href="classvireo_1_1CommandList.html#abd8c18c11d369fcc8f84e88cb69dc52d">vireo::CommandList::uploadArray</a> methods you can easily upload data into a buffer. The <code>upload</code> methods will take care of the staging buffer and temporary copy of the data for you, which can be tricky if you have multiple mip levels or multiples image layers.</p>
<p>The GPU commands recorded with a <a class="el" href="manual_050_00_commands.html">CommandList</a> are executed asynchronously by the GPU. Once you have uploaded all of the data using one<code>CommandList</code> you need to call <a class="el" href="classvireo_1_1CommandList.html#acbb28cf8bdd606e0131fc72218504abc">vireo::CommandList::cleanup</a> on this <code>CommandList</code> to clear the temporary (staging) buffers used for the host-to-device transfers. The asynchronous nature of the operation means that we have to wait for the end of the operation to free the host-visible allocated memory, which mean you have to call <code>cleanup</code> only after the <a class="el" href="manual_060_00_queues.html">submit queue</a> have finished the commands execution by blocking the CPU-side with <a class="el" href="classvireo_1_1SubmitQueue.html#a899a95c062c476e0f4616683c81a77d0">vireo::SubmitQueue::waitIdle</a>.</p>
<dl class="section note"><dt>Note</dt><dd>Since the call to <code>cleanup</code> is done automatically in the command list destructor, you only have to call it explicitly on non-temporary command lists.</dd></dl>
<div class="fragment"><div class="line"><span class="comment">// Example of a texture upload using upload()</span></div>
<div class="line"><span class="comment">// In a local scope for temporary objects destruction</span></div>
<div class="line">{</div>
<div class="line">    <span class="comment">// Load texture data from the disk</span></div>
<div class="line">    <span class="keyword">auto</span>* pixels = .... <span class="comment">// insert the call to your preferred image loading library</span></div>
<div class="line"> </div>
<div class="line">    <span class="comment">// Allocate the texture in device-only memory</span></div>
<div class="line">    texture = <a class="code" href="namespacevireo.html">vireo</a>-&gt;createImage(<a class="code" href="namespacevireo.html#a22f6b18e781e3c412e7d243f7de6aa5ca5c835c7ea238d0796853827ce416a5e2">vireo::ImageFormat::R8G8B8A8_SRGB</a>);</div>
<div class="line"> </div>
<div class="line">    <span class="comment">// Create a command list</span></div>
<div class="line">    <span class="keyword">const</span> <span class="keyword">auto</span> uploadCommandAllocator = <a class="code" href="namespacevireo.html">vireo</a>-&gt;createCommandAllocator(<a class="code" href="namespacevireo.html#a21e038f5b8958e203d28bc4f18472352aeb5ddb3b6096fb90ff720d9c3e2a6628" title="Command/Queue for copy operations. ">vireo::CommandType::TRANSFER</a>);</div>
<div class="line">    <span class="keyword">const</span> <span class="keyword">auto</span> uploadCommandList = uploadCommandAllocator-&gt;createCommandList();</div>
<div class="line"> </div>
<div class="line">    uploadCommandList-&gt;begin();</div>
<div class="line">    <span class="comment">// insert a memory barrier to prepare the image to be written</span></div>
<div class="line">    uploadCommandList-&gt;barrier(texture, <a class="code" href="namespacevireo.html#ae046059fd4567480e8f03be6171dafd1a0db45d2a4141101bdfe48e3314cfbca3" title="Not used. ">vireo::ResourceState::UNDEFINED</a>, <a class="code" href="namespacevireo.html#a33ee7da93cb9c170c97d8e60f3187705aba1c00f34d04b40f9e1eddd20de122de" title="Used as a destination of a transfer/copy/blit command. ">vireo::ResourceState::COPY_DST</a>);</div>
<div class="line">    <span class="comment">// record copy command</span></div>
<div class="line">    uploadCommandList-&gt;upload(stagingBuffer, texture);</div>
<div class="line">    uploadCommandList-&gt;end();</div>
<div class="line"> </div>
<div class="line">    <span class="comment">// Execute the copy command</span></div>
<div class="line">    <span class="keyword">const</span> <span class="keyword">auto</span> transferQueue = <a class="code" href="namespacevireo.html">vireo</a>-&gt;createSubmitQueue(<a class="code" href="namespacevireo.html#a21e038f5b8958e203d28bc4f18472352aeb5ddb3b6096fb90ff720d9c3e2a6628" title="Command/Queue for copy operations. ">vireo::CommandType::TRANSFER</a>);</div>
<div class="line">    transferQueue-&gt;submit({uploadCommandList});</div>
<div class="line"> </div>
<div class="line">    <span class="comment">// Wait for the command to executed by the GPU</span></div>
<div class="line">    transferQueue-&gt;waitIdle();</div>
<div class="line">} <span class="comment">// cleanup() is automatically called</span></div>
</div><!-- end fragment -->
<dl class="section note"><dt>Note</dt><dd>It's more efficient to load the image data from the disk directly into the staging buffer by using the <a class="el" href="classvireo_1_1Buffer.html#ad8bebf5aa656b037de89b9c8636f232b">mapped address</a>, but you need to use the <code>copy()</code> method below.</dd></dl>
<h3>using copy()</h3>
<p>This method can be useful if you want, for example, to write data directly into the staging buffer to avoid a CPU-to-CPU transfer or if you need to copy one mip level independently from the others.</p>
<p>When using <a class="el" href="classvireo_1_1CommandList.html#a911fb333be3ee284750df201a21d1ad2">vireo::CommandList::copy</a> you need to copy the image data into a temporary, host-accessible (staging) buffer, then you ask the GPU to copy the data to the image in device-only memory (memory only accessible by the GPU). Remember that you have to keep the staging buffer alive until the copy command have been executed (you may need to wait on the CPU side for the completion of the commands on the submit queue).</p>
<div class="fragment"><div class="line"><span class="comment">// Example of a texture upload using copy()</span></div>
<div class="line"><span class="comment">// In a local scope for temporary objects destruction</span></div>
<div class="line">{</div>
<div class="line">    <span class="comment">// Load texture data from the disk</span></div>
<div class="line">    <span class="keyword">auto</span>* pixels = .... <span class="comment">// insert the call to your preferred image loading library</span></div>
<div class="line"> </div>
<div class="line">    <span class="comment">// Allocate the texture in device-only memory</span></div>
<div class="line">    texture = <a class="code" href="namespacevireo.html">vireo</a>-&gt;createImage(<a class="code" href="namespacevireo.html#a22f6b18e781e3c412e7d243f7de6aa5ca5c835c7ea238d0796853827ce416a5e2">vireo::ImageFormat::R8G8B8A8_SRGB</a>);</div>
<div class="line"> </div>
<div class="line">    <span class="comment">// Allocate the staging buffer in host-accessible memory</span></div>
<div class="line">    <span class="keyword">const</span> <span class="keyword">auto</span> stagingBuffer = <a class="code" href="namespacevireo.html">vireo</a>-&gt;createBuffer(<a class="code" href="namespacevireo.html#adf8e136713c0691010d2bec6ba63e9cfae99309ceea2a2e7aa305a98a8484ace7" title="Used for image copy operations (from host visible memory to GPU memory) ">vireo::BufferType::IMAGE_UPLOAD</a>, texture-&gt;getImageSize());</div>
<div class="line"> </div>
<div class="line">    <span class="comment">// Copy the image data into the staging buffer</span></div>
<div class="line">    stagingBuffer-&gt;map();</div>
<div class="line">    stagingBuffer-&gt;write(pixels);</div>
<div class="line"> </div>
<div class="line">    <span class="comment">// Create a command list</span></div>
<div class="line">    <span class="keyword">const</span> <span class="keyword">auto</span> uploadCommandAllocator = <a class="code" href="namespacevireo.html">vireo</a>-&gt;createCommandAllocator(<a class="code" href="namespacevireo.html#a21e038f5b8958e203d28bc4f18472352aeb5ddb3b6096fb90ff720d9c3e2a6628" title="Command/Queue for copy operations. ">vireo::CommandType::TRANSFER</a>);</div>
<div class="line">    <span class="keyword">const</span> <span class="keyword">auto</span> uploadCommandList = uploadCommandAllocator-&gt;createCommandList();</div>
<div class="line"> </div>
<div class="line">    uploadCommandList-&gt;begin();</div>
<div class="line">    <span class="comment">// insert a memory barrier to prepare the image to be written</span></div>
<div class="line">    uploadCommandList-&gt;barrier(texture, <a class="code" href="namespacevireo.html#ae046059fd4567480e8f03be6171dafd1a0db45d2a4141101bdfe48e3314cfbca3" title="Not used. ">vireo::ResourceState::UNDEFINED</a>, <a class="code" href="namespacevireo.html#a33ee7da93cb9c170c97d8e60f3187705aba1c00f34d04b40f9e1eddd20de122de" title="Used as a destination of a transfer/copy/blit command. ">vireo::ResourceState::COPY_DST</a>);</div>
<div class="line">    <span class="comment">// record copy command</span></div>
<div class="line">    uploadCommandList-&gt;copy(stagingBuffer, texture);</div>
<div class="line">    uploadCommandList-&gt;end();</div>
<div class="line"> </div>
<div class="line">    <span class="comment">// Execute the copy command</span></div>
<div class="line">    <span class="keyword">const</span> <span class="keyword">auto</span> transferQueue = <a class="code" href="namespacevireo.html">vireo</a>-&gt;createSubmitQueue(<a class="code" href="namespacevireo.html#a21e038f5b8958e203d28bc4f18472352aeb5ddb3b6096fb90ff720d9c3e2a6628" title="Command/Queue for copy operations. ">vireo::CommandType::TRANSFER</a>);</div>
<div class="line">    transferQueue-&gt;submit({uploadCommandList});</div>
<div class="line"> </div>
<div class="line">    <span class="comment">// Wait for the command to executed by the GPU</span></div>
<div class="line">    transferQueue-&gt;waitIdle();</div>
<div class="line">} <span class="comment">// unmap() is automatically called on the staging buffer and the staging buffer is destroyed</span></div>
</div><!-- end fragment -->
<dl class="section note"><dt>Note</dt><dd>It's more efficient to load the image data from the disk directly into the staging buffer by using the <a class="el" href="classvireo_1_1Buffer.html#ad8bebf5aa656b037de89b9c8636f232b">mapped address</a>.</dd></dl>
<h2>Downloading an image</h2>
<p>Downloading an image to save the result of a rendering or the result of a compute shader is similar to uploading with <code>copy</code> :</p><ul>
<li>Allocate a staging buffer</li>
<li>Copy the image to the buffer</li>
<li>Use <code>map()</code> to access the memory</li>
</ul>
<p>The main difference is that you have to take care of the memory alignment of the rows of the image imposed by the graphic API :</p>
<div class="fragment"><div class="line"><span class="comment">// Start recording commands</span></div>
<div class="line">commandList-&gt;begin();</div>
<div class="line"> </div>
<div class="line"><span class="comment">// Create a temporary, host-visible memory buffer</span></div>
<div class="line"><span class="keyword">const</span> <span class="keyword">auto</span> buffer = <a class="code" href="namespacevireo.html">vireo</a>-&gt;createBuffer(<a class="code" href="namespacevireo.html#adf8e136713c0691010d2bec6ba63e9cfa2cf32e0ddf0b8980d3c694117697749a" title="Used for image copy operations (from GPU memory to host visible) ">vireo::BufferType::IMAGE_DOWNLOAD</a>, image-&gt;getAlignedImageSize());</div>
<div class="line"> </div>
<div class="line"><span class="comment">// Copy image to buffer</span></div>
<div class="line"><span class="comment">// The image must be in the COPY_SRC state; insert a barrier if needed</span></div>
<div class="line">commandList-&gt;copy(image, buffer);</div>
<div class="line"> </div>
<div class="line"><span class="comment">// End recording commands</span></div>
<div class="line">commandList-&gt;end();</div>
<div class="line"> </div>
<div class="line"><span class="comment">// Submit work to the GPU and wait for the command execution</span></div>
<div class="line">graphicSubmitQueue-&gt;submit({commandList});</div>
<div class="line">graphicSubmitQueue-&gt;waitIdle();</div>
<div class="line"> </div>
<div class="line"><span class="comment">// Map the buffer to the CPU virtual address space</span></div>
<div class="line">buffer-&gt;map();</div>
<div class="line"><span class="keyword">const</span> <span class="keyword">auto</span>* source = <span class="keyword">static_cast&lt;</span>uint8_t*<span class="keyword">&gt;</span>(buffer-&gt;getMappedAddress());</div>
<div class="line"> </div>
<div class="line"><span class="comment">// Copy the image row by row in CPU memory</span></div>
<div class="line"><span class="keyword">const</span> <span class="keyword">auto</span> rowPitch = image-&gt;getRowPitch();</div>
<div class="line"><span class="keyword">const</span> <span class="keyword">auto</span> alignedRowPitch = image-&gt;getAlignedRowPitch();</div>
<div class="line">std::vector&lt;uint8_t&gt; imageData(image-&gt;getImageSize());</div>
<div class="line"><span class="keywordflow">for</span> (<span class="keywordtype">int</span> y = 0; y &lt; image-&gt;getHeight(); ++y) {</div>
<div class="line">    memcpy(&amp;imageData[y * rowPitch], &amp;source[y * alignedRowPitch], rowPitch);</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="comment">// Write data to a file</span></div>
<div class="line">stbi_write_png(<span class="stringliteral">&quot;output.png&quot;</span>,</div>
<div class="line">    image-&gt;getWidth(),</div>
<div class="line">    image-&gt;getHeight(),</div>
<div class="line">    image-&gt;getPixelSize(image-&gt;getFormat()),</div>
<div class="line">    imageData.data(),</div>
<div class="line">    rowPitch);</div>
</div><!-- end fragment -->
 </div></div><!-- contents -->
</div><!-- doc-content -->
<!-- Generated by DoxyPress 1.7.0 -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="navelem"><a class="el" href="manual.html">Manual</a></li><li class="navelem"><a class="el" href="manual_030_00_resources.html">Resources</a></li>
    <li class="footer">Generated on ven. juin 13 2025 15:18:38 for Vireo &nbsp; by
    <a href="https://www.copperspice.com/documentation-doxypress.html">
    <img class="footer" src="doxypress.png" alt="DoxyPress"/></a> 1.7.0 </li>
  </ul>
</div>
</body>
</html>
